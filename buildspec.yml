version: 0.2
env:
  secrets-manager:
    HOST: "$SECRET_NAME:host"
    PORT: "$SECRET_NAME:port"
    DATABASE: "$SECRET_NAME:database"
    USER: "$SECRET_NAME:user"
    PASSWORD: "$SECRET_NAME:password"
phases:
  pre_build:
    commands:
      - echo Build started on `date`
      - wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/8.4.1/flyway-commandline-8.4.1-linux-x64.tar.gz | tar xvz && ln -s `pwd`/flyway-8.4.1/flyway /usr/local/bin 
      - pip install psycopg2
  build:
    commands:
      - echo $GITHUB_EVENT_NAME
      - echo $ENVIRONMENT
      - ls -l
      - cd scripts 
      - python main.py
      - cd ..
      - cd temp
      - ls -lR
      - |
        if [ "$GITHUB_EVENT_NAME" = "push" ]
        then
          echo Starting up validate.sh
          chmod +x ./validate.sh
          while read line; do $line; done < validate.sh
        fi
      - echo Starting up $SCRIPT_NAME...
      - chmod +x ./$SCRIPT_NAME
      - while read line; do $line; done < $SCRIPT_NAME
  post_build:
   commands:
     - echo Entering post-build phase...
     - echo Build finished on `date`
