version: 0.2
env:
  secrets-manager:
    #HOST: "$SECRET_NAME:host"
    #PORT: "$SECRET_NAME:port"
    #DATABASE: "$SECRET_NAME:database"
    #USER: "$SECRET_NAME:user"
    #PASSWORD: "$SECRET_NAME:password"
    USER: "development/ab-demo/snowflake-credentials:user"
    PASSWORD: "development/ab-demo/snowflake-credentials:password"
    ACCOUNT: "development/ab-demo/snowflake-credentials:account"

phases:
  pre_build:
    commands:
      - echo Build started on `date`
      - virtualenv flyway_validate
      - . flyway_validate/bin/activate
      - pip install --upgrade pip
      - pip install -r https://raw.githubusercontent.com/snowflakedb/snowflake-connector-python/v2.6.2/tested_requirements/requirements_39.reqs
      - pip install snowflake-connector-python==2.6.2
      - wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/8.4.1/flyway-commandline-8.4.1-linux-x64.tar.gz | tar xvz 1> /dev/null && ln -s `pwd`/flyway-8.4.1/flyway /usr/local/bin 
  build:
    commands:
      - pwd
      - echo $GITHUB_EVENT_NAME
      - echo $ENVIRONMENT
      - ls -l
      - python ./scripts/main.py
      - cd temp
      - ls -l
      - echo Starting up validate.sh...
      - chmod +x ./validate.sh
      - ./validate.sh
  post_build:
    commands:
      - echo Entering post-build phase...
      - |
        if [ "$CODEBUILD_BUILD_SUCCEEDING" = "0" ]
        then exit 1
        fi
      - |
        if [ "$GITHUB_EVENT_NAME" = "push" ]
        then
          echo Starting up migrate.sh...
          chmod +x ./migrate.sh
          ./migrate.sh
        fi
      - echo Build finished on `date`
